# 要件定義書

## はじめに

本システムは、既存の仕様駆動開発管理サイトにGitHub APIとの統合機能を追加し、CI結果を自動的に取得・更新する機能を提供します。GitHub Actionsやその他のCI/CDパイプラインの実行結果を定期的に取得し、プロジェクトのCI結果データを自動更新することで、手動入力の手間を削減し、リアルタイムでの品質メトリクス追跡を実現します。

## 用語集

- **System**: GitHub CI統合システム（GitHub CI Integration System）
- **GitHub API**: GitHubが提供するREST APIサービス
- **CI Result**: 継続的インテグレーションの実行結果（合否、メトリクス、ログURL）
- **Workflow Run**: GitHub Actionsのワークフロー実行インスタンス
- **Repository**: GitHubリポジトリ
- **Personal Access Token**: GitHub APIアクセス用の認証トークン
- **Rate Limit**: GitHub APIの使用制限
- **Auto Sync**: CI結果の自動同期機能
- **Manual Sync**: ユーザーが手動で実行する同期機能
- **Sync Status**: 同期処理の状態（成功、失敗、進行中）

## 要件

### 要件 1

**ユーザーストーリー:** プロジェクトにGitHubリポジトリを関連付けたい。そうすることで、そのリポジトリのCI結果を自動取得できる。

#### 受入基準

1. WHEN ユーザーがプロジェクト編集フォームを開く THEN システムはGitHubリポジトリURL入力フィールドを表示しなければならない
2. WHEN ユーザーがGitHubリポジトリURLを入力する THEN システムはURL形式（https://github.com/owner/repo）を検証しなければならない
3. WHEN ユーザーが有効なリポジトリURLを保存する THEN システムはプロジェクトデータにリポジトリ情報を追加しなければならない
4. WHEN プロジェクト詳細ページを表示する THEN システムは関連付けられたリポジトリ情報を表示しなければならない
5. WHEN ユーザーがリポジトリURLを削除する THEN システムは自動同期を無効化し、手動CI結果入力に戻さなければならない

### 要件 2

**ユーザーストーリー:** GitHub APIアクセス用の認証情報を設定したい。そうすることで、プライベートリポジトリのCI結果も取得できる。

#### 受入基準

1. WHEN ユーザーが設定ページにアクセスする THEN システムはPersonal Access Token入力フィールドを表示しなければならない
2. WHEN ユーザーがPersonal Access Tokenを入力する THEN システムはトークンをブラウザのlocalStorageに暗号化して保存しなければならない
3. WHEN ユーザーがトークンを保存する THEN システムはGitHub APIへのテスト接続を実行し、結果を表示しなければならない
4. WHEN GitHub API接続テストが失敗する THEN システムはエラーメッセージと対処方法を表示しなければならない
5. WHEN ユーザーがトークンを削除する THEN システムはlocalStorageからトークンを完全に削除し、パブリックリポジトリのみアクセス可能にしなければならない

### 要件 3

**ユーザーストーリー:** GitHubリポジトリのCI結果を手動で同期したい。そうすることで、最新のCI状態を即座に確認できる。

#### 受入基準

1. WHEN プロジェクト詳細ページのCI結果タブを表示する THEN システムはGitHubリポジトリが関連付けられている場合に「同期」ボタンを表示しなければならない
2. WHEN ユーザーが同期ボタンをクリックする THEN システムはGitHub APIからワークフロー実行結果を取得しなければならない
3. WHEN GitHub APIから結果を取得する THEN システムは最新の10件のワークフロー実行を取得しなければならない
4. WHEN ワークフロー実行データを処理する THEN システムは各実行の合否ステータス、実行時刻、ログURLを抽出しなければならない
5. WHEN 新しいCI結果を検出する THEN システムは既存のlocalStorageデータに追加し、重複を避けなければならない
6. WHEN 同期処理中にエラーが発生する THEN システムはエラーメッセージを表示し、部分的な結果があれば保存しなければならない
7. WHEN 同期が完了する THEN システムは成功メッセージと取得件数を表示しなければならない

### 要件 4

**ユーザーストーリー:** CI結果の自動同期を設定したい。そうすることで、定期的にCI状態を更新し、手動操作なしで最新情報を維持できる。

#### 受入基準

1. WHEN ユーザーが設定ページにアクセスする THEN システムは自動同期の有効/無効切り替えオプションを表示しなければならない
2. WHEN ユーザーが自動同期を有効にする THEN システムは同期間隔（5分、15分、30分、1時間）の選択肢を表示しなければならない
3. WHEN ユーザーが自動同期設定を保存する THEN システムは設定をlocalStorageに保存し、バックグラウンド同期を開始しなければならない
4. WHEN 自動同期が実行される THEN システムはGitHubリポジトリが関連付けられたすべてのプロジェクトを対象にしなければならない
5. WHEN バックグラウンド同期中にエラーが発生する THEN システムはエラーログを記録し、次回の同期スケジュールを維持しなければならない
6. WHEN ユーザーがページを表示中に自動同期が実行される THEN システムは表示を自動更新し、新しいCI結果を反映しなければならない
7. WHEN ユーザーが自動同期を無効にする THEN システムはバックグラウンド処理を停止しなければならない

### 要件 5

**ユーザーストーリー:** GitHub APIのレート制限を適切に管理したい。そうすることで、API制限に達することなく安定してCI結果を取得できる。

#### 受入基準

1. WHEN GitHub APIを呼び出す THEN システムは現在のレート制限状況を確認しなければならない
2. WHEN レート制限に近づいている THEN システムは同期頻度を自動的に調整し、制限回避を図らなければならない
3. WHEN レート制限に達した THEN システムは制限リセット時刻まで同期を一時停止し、ユーザーに通知しなければならない
4. WHEN 設定ページを表示する THEN システムは現在のAPI使用状況とリセット時刻を表示しなければならない
5. WHEN 複数のプロジェクトが同時に同期される THEN システムはAPI呼び出しを適切に間隔を空けて実行しなければならない
6. システムは認証済みユーザーの場合は5000リクエスト/時間、未認証の場合は60リクエスト/時間の制限を考慮しなければならない

### 要件 6

**ユーザーストーリー:** GitHub Actionsの詳細なメトリクスを取得したい。そうすることで、lint結果、テストカバレッジ、その他の品質指標を自動的に記録できる。

#### 受入基準

1. WHEN ワークフローの実行結果を取得する THEN システムはワークフローのジョブ詳細を解析しなければならない
2. WHEN ジョブにlint結果が含まれる THEN システムはエラー数、警告数を抽出しなければならない
3. WHEN ジョブにテスト結果が含まれる THEN システムは総テスト数、成功数、失敗数を抽出しなければならない
4. WHEN ジョブにカバレッジ情報が含まれる THEN システムはカバレッジ率を抽出しなければならない
5. WHEN ワークフローアーティファクトが利用可能な場合 THEN システムはSBOMファイルの存在を確認しなければならない
6. WHEN メトリクス抽出に失敗する THEN システムは基本的なCI結果（合否、実行時刻、ログURL）のみを保存しなければならない
7. システムは一般的なGitHub Actionsワークフロー（Node.js、Python、Java、.NET）のメトリクス抽出をサポートしなければならない

### 要件 7

**ユーザーストーリー:** 同期履歴とエラーログを確認したい。そうすることで、同期の問題を診断し、システムの動作状況を把握できる。

#### 受入基準

1. WHEN 設定ページにアクセスする THEN システムは同期履歴セクションを表示しなければならない
2. WHEN 同期履歴を表示する THEN システムは各同期の実行時刻、対象プロジェクト、結果、取得件数を表示しなければならない
3. WHEN 同期でエラーが発生した場合 THEN システムはエラーメッセージと詳細情報を履歴に記録しなければならない
4. WHEN ユーザーが履歴の詳細を確認する THEN システムは同期されたCI結果の詳細情報を表示しなければならない
5. WHEN 履歴が100件を超える THEN システムは古い履歴を自動的に削除し、最新100件を保持しなければならない
6. WHEN ユーザーが履歴をクリアする THEN システムはすべての同期履歴を削除し、確認ダイアログを表示しなければならない

### 要件 8

**ユーザーストーリー:** 複数のワークフローを持つリポジトリに対応したい。そうすることで、異なる目的のCI/CDパイプライン結果をすべて取得できる。

#### 受入基準

1. WHEN リポジトリに複数のワークフローが存在する THEN システムはすべてのワークフローの実行結果を取得しなければならない
2. WHEN ワークフロー結果を表示する THEN システムは各結果にワークフロー名を含めなければならない
3. WHEN ユーザーがワークフローをフィルタリングしたい場合 THEN システムは特定のワークフロー名でのフィルタリング機能を提供しなければならない
4. WHEN 同じ時刻に複数のワークフローが実行される THEN システムは各ワークフローの結果を個別のCI結果として記録しなければならない
5. WHEN ワークフロー設定を変更する THEN システムは対象ワークフローの選択機能を提供しなければならない

### 要件 9

**ユーザーストーリー:** GitHub以外のCI/CDサービスとの統合も将来的に対応したい。そうすることで、多様な開発環境に対応できる拡張可能なシステムを構築できる。

#### 受入基準

1. システムはCI結果取得のためのプラグイン可能なアーキテクチャを採用しなければならない
2. WHEN 新しいCI/CDサービスを追加する THEN システムは既存のGitHub統合に影響を与えることなく拡張可能でなければならない
3. WHEN プロジェクト設定を行う THEN システムはCI/CDサービスの種類を選択できるインターフェースを提供しなければならない
4. システムは各CI/CDサービス固有の認証方法と設定を独立して管理しなければならない
5. WHEN 複数のCI/CDサービスが設定される THEN システムは各サービスからの結果を統合して表示しなければならない

### 要件 10

**ユーザーストーリー:** オフライン環境や制限されたネットワーク環境でも基本機能を維持したい。そうすることで、GitHub APIにアクセスできない状況でも手動入力による運用を継続できる。

#### 受入基準

1. WHEN GitHub APIへの接続が失敗する THEN システムは手動CI結果入力モードに自動的に切り替わらなければならない
2. WHEN オフライン状態を検出する THEN システムは自動同期を一時停止し、ユーザーに状態を通知しなければならない
3. WHEN ネットワーク接続が復旧する THEN システムは自動同期を再開し、蓄積された変更を同期しなければならない
4. システムはオンライン/オフライン状態に関係なく、既存のCI結果表示機能を維持しなければならない
5. WHEN 部分的な同期が完了している THEN システムは取得済みのデータを保持し、失敗した部分のみ再試行しなければならない