# GitHub Personal Access Token 設定ガイド

## 📋 目次

1. [Personal Access Tokenとは](#personal-access-tokenとは)
2. [トークンの作成手順](#トークンの作成手順)
3. [トークンの設定手順](#トークンの設定手順)
4. [接続テスト](#接続テスト)
5. [トラブルシューティング](#トラブルシューティング)

---

## Personal Access Tokenとは

Personal Access Token（PAT）は、GitHubのAPIにアクセスするための認証トークンです。このトークンを使用することで、プライベートリポジトリのCI結果も取得できるようになります。

### 必要な権限

GitHub CI統合機能では、以下の権限が必要です：

#### Fine-grained tokens（推奨）

**Repository permissions:**
- ✅ **Actions: Read-only** - GitHub Actionsのワークフロー実行結果を読み取り
- ✅ **Commit statuses: Read-only** - コミットステータスを読み取り
- ✅ **Contents: Read-only** - リポジトリの内容を読み取り
- ✅ **Metadata: Read-only** - リポジトリのメタデータを読み取り（自動設定）

#### Classic tokens（旧形式）

- ✅ **repo:status** - コミットステータスへのアクセス
- ✅ **repo_deployment** - デプロイメントステータスへのアクセス
- ✅ **public_repo** - パブリックリポジトリへのアクセス（パブリックリポジトリのみの場合）

---

## トークンの作成手順

### ステップ1: GitHubの設定ページにアクセス

1. GitHubにログインします
2. 右上のプロフィールアイコンをクリック
3. **Settings**（設定）を選択

![GitHub Settings](https://docs.github.com/assets/cb-45016/mw-1440/images/help/settings/userbar-account-settings-global-nav-update.webp)

### ステップ2: Developer settingsに移動

1. 左サイドバーの一番下にある **Developer settings** をクリック
2. **Personal access tokens** を展開
3. **Fine-grained tokens** を選択（推奨）

![Developer Settings](https://docs.github.com/assets/cb-8213/mw-1440/images/help/settings/developer-settings-personal-access-tokens.webp)

### ステップ3: 新しいトークンを生成

1. **Generate new token** ボタンをクリック

![Generate Token](https://docs.github.com/assets/cb-43299/mw-1440/images/help/settings/generate-new-token.webp)

### ステップ4: トークンの設定

以下の情報を入力します：

#### Token name（トークンの名前）
```
Spec Tracking Site - CI Integration
```
または任意の識別しやすい名前

#### Expiration（有効期限）
推奨: **90 days**（90日間）
- セキュリティのため、定期的な更新を推奨
- 必要に応じて **Custom**（カスタム）で期間を設定可能

#### Description（説明）- オプション
```
仕様駆動開発管理サイトのGitHub CI統合用トークン
```

#### Repository access（リポジトリアクセス）

以下のいずれかを選択：

**オプション1: 特定のリポジトリのみ（推奨）**
- ✅ **Only select repositories** を選択
- ドロップダウンから監視したいリポジトリを選択
  - 例: `HIT-maruyama/spec-tracking-site`

**オプション2: すべてのリポジトリ**
- **All repositories** を選択（注意: セキュリティリスクが高い）

#### Permissions（権限の設定）

**Repository permissions** セクションで以下を設定：

| 権限項目 | 設定値 | 説明 |
|---------|--------|------|
| **Actions** | `Read-only` | GitHub Actionsのワークフロー実行結果を読み取り |
| **Commit statuses** | `Read-only` | コミットステータスを読み取り |
| **Contents** | `Read-only` | リポジトリの内容を読み取り |
| **Metadata** | `Read-only` | リポジトリのメタデータを読み取り（自動設定） |

**最小限の権限設定（推奨）:**
```
✅ Actions: Read-only
✅ Commit statuses: Read-only
✅ Contents: Read-only
✅ Metadata: Read-only (自動)
```

**注意**: 
- 必要最小限の権限のみを付与することをお勧めします
- すべて **Read-only**（読み取り専用）で十分です
- **Write**（書き込み）権限は不要です

### ステップ5: トークンの生成

1. ページ下部の **Generate token** ボタンをクリック
2. 生成されたトークンが表示されます

⚠️ **重要**: トークンは一度しか表示されません！必ずコピーして安全な場所に保存してください。

```
例: ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

## トークンの設定手順

### ステップ1: 設定ページにアクセス

1. ブラウザで以下のURLを開きます：
```
https://hit-maruyama.github.io/spec-tracking-site/settings.html
```

または

2. メインページから「設定」リンクをクリック

### ステップ2: GitHub統合設定セクションを確認

設定ページの「GitHub統合設定」セクションを見つけます。

### ステップ3: Personal Access Tokenを入力

1. **Personal Access Token** 入力フィールドを見つけます
2. GitHubで生成したトークンを貼り付けます
   ```
   ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

### ステップ4: トークンを保存

1. **保存** ボタンをクリック
2. トークンが暗号化されてブラウザのLocalStorageに保存されます
3. 成功メッセージが表示されます：
   ```
   ✓ Personal Access Tokenを保存しました
   ```

### ステップ5: 接続テストを実行

1. **接続テスト** ボタンをクリック
2. GitHub APIへの接続が確認されます
3. 成功メッセージが表示されます：
   ```
   ✓ GitHub APIへの接続に成功しました
   ```

---

## 接続テスト

### 接続テストの実行方法

設定ページで **接続テスト** ボタンをクリックすると、以下が確認されます：

1. ✅ トークンが有効であること
2. ✅ GitHub APIにアクセスできること
3. ✅ 必要な権限が付与されていること
4. ✅ レート制限の状態

### 成功時の表示

```
✓ GitHub APIへの接続に成功しました

API使用状況:
- 残り回数: 4,999 / 5,000
- リセット時刻: 2024-12-17 15:30:00
```

### 失敗時の表示

```
✗ GitHub APIへの接続に失敗しました

エラー: 認証に失敗しました
対処方法: Personal Access Tokenを確認してください
```

---

## 自動同期の設定

トークンの設定が完了したら、自動同期を有効化できます。

### ステップ1: 自動同期を有効化

1. 設定ページの「自動同期設定」セクションを見つけます
2. **自動同期を有効にする** チェックボックスをオンにします

### ステップ2: 同期間隔を設定

同期間隔を選択します：
- 5分
- 15分（推奨）
- 30分
- 1時間

### ステップ3: 設定を保存

1. **保存** ボタンをクリック
2. 自動同期が開始されます
3. 成功メッセージが表示されます：
   ```
   ✓ 自動同期設定を保存しました
   ```

---

## プロジェクトとリポジトリの関連付け

### ステップ1: プロジェクト詳細ページを開く

1. メインページでプロジェクトをクリック
2. プロジェクト詳細ページが開きます

### ステップ2: GitHubリポジトリURLを設定

1. **編集** ボタンをクリック
2. **GitHubリポジトリURL** フィールドに以下の形式でURLを入力：
   ```
   https://github.com/owner/repository
   ```
   例:
   ```
   https://github.com/HIT-maruyama/spec-tracking-site
   ```

3. **保存** ボタンをクリック

### ステップ3: 手動同期を実行

1. CI結果タブを開きます
2. **同期** ボタンが表示されます
3. **同期** ボタンをクリックして手動同期を実行
4. 同期が完了すると、最新のCI結果が表示されます

---

## トラブルシューティング

### 問題1: トークンが保存できない

**症状**: 保存ボタンをクリックしてもエラーが表示される

**原因と解決方法**:

1. **ブラウザの暗号化機能がサポートされていない**
   - 解決: モダンブラウザ（Chrome、Firefox、Safari、Edge）を使用
   - 確認: ブラウザのコンソールで `crypto.subtle` が利用可能か確認

2. **プライベートブラウジングモード**
   - 解決: 通常モードでブラウザを開く
   - LocalStorageが無効になっている可能性があります

3. **LocalStorageの容量超過**
   - 解決: ブラウザのLocalStorageをクリア
   - 開発者ツール > Application > Local Storage > Clear

### 問題2: 接続テストが失敗する

**症状**: 「GitHub APIへの接続に失敗しました」と表示される

**原因と解決方法**:

1. **トークンが無効**
   - 解決: GitHubで新しいトークンを生成して再設定
   - 確認: トークンが正しくコピーされているか確認

2. **権限が不足**
   - 解決: トークンに必要な権限（repo:status、repo_deployment）を付与
   - 確認: GitHubのトークン設定ページで権限を確認

3. **トークンの有効期限切れ**
   - 解決: 新しいトークンを生成
   - 確認: GitHubのトークン一覧で有効期限を確認

4. **ネットワークエラー**
   - 解決: インターネット接続を確認
   - 確認: ブラウザのコンソールでネットワークエラーを確認

### 問題3: レート制限に達した

**症状**: 「GitHub APIのレート制限に達しました」と表示される

**原因と解決方法**:

1. **認証なしでAPIを使用している**
   - 解決: Personal Access Tokenを設定
   - 認証なし: 60リクエスト/時間
   - 認証あり: 5,000リクエスト/時間

2. **短時間に多数のリクエスト**
   - 解決: 自動同期の間隔を長くする（30分または1時間）
   - 確認: 設定ページでAPI使用状況を確認

3. **レート制限のリセット待ち**
   - 解決: リセット時刻まで待つ
   - 確認: 設定ページでリセット時刻を確認

### 問題4: 同期が実行されない

**症状**: 手動同期ボタンをクリックしても何も起こらない

**原因と解決方法**:

1. **リポジトリURLが設定されていない**
   - 解決: プロジェクト編集でGitHubリポジトリURLを設定

2. **リポジトリURLの形式が間違っている**
   - 解決: 正しい形式で入力
   - 正しい: `https://github.com/owner/repo`
   - 間違い: `github.com/owner/repo`、`https://github.com/owner/repo.git`

3. **リポジトリが存在しない**
   - 解決: リポジトリURLを確認
   - 確認: ブラウザでURLを開いて存在を確認

4. **リポジトリへのアクセス権限がない**
   - 解決: プライベートリポジトリの場合、トークンに適切な権限を付与
   - 確認: GitHubでリポジトリにアクセスできるか確認

### 問題5: CI結果が表示されない

**症状**: 同期は成功するが、CI結果が表示されない

**原因と解決方法**:

1. **ワークフローが実行されていない**
   - 解決: GitHubでワークフローを実行
   - 確認: リポジトリのActionsタブで実行履歴を確認

2. **ワークフローの実行が完了していない**
   - 解決: ワークフローの完了を待つ
   - 確認: 「completed」ステータスのワークフローのみが取得されます

3. **ワークフローが10件より古い**
   - 解決: 最新の10件のみが取得されます
   - 確認: より新しいワークフローを実行

---

## セキュリティのベストプラクティス

### 1. トークンの管理

- ✅ トークンは安全な場所に保管
- ✅ 定期的にトークンを更新（90日ごと推奨）
- ✅ 使用しなくなったトークンは削除
- ✅ トークンを他人と共有しない

### 2. 権限の最小化

- ✅ 必要最小限の権限のみを付与
- ✅ パブリックリポジトリのみの場合は `public_repo` のみ
- ✅ 定期的に権限を見直す

### 3. トークンの暗号化

- ✅ システムは自動的にトークンを暗号化して保存
- ✅ ブラウザのLocalStorageに暗号化されて保存
- ✅ 平文では保存されません

### 4. トークンの削除

使用しなくなった場合は、以下の手順でトークンを削除：

1. **設定ページで削除**
   - 設定ページの「トークンを削除」ボタンをクリック

2. **GitHubで削除**
   - GitHub > Settings > Developer settings > Personal access tokens
   - 該当トークンの「Delete」をクリック

---

## よくある質問（FAQ）

### Q1: トークンは必須ですか？

**A**: いいえ、パブリックリポジトリのみを使用する場合は不要です。ただし、以下の制限があります：
- レート制限: 60リクエスト/時間（認証ありは5,000リクエスト/時間）
- プライベートリポジトリにはアクセスできません

### Q2: トークンの有効期限が切れたらどうなりますか？

**A**: 同期が失敗し、エラーメッセージが表示されます。新しいトークンを生成して再設定してください。

### Q3: 複数のプロジェクトで同じトークンを使用できますか？

**A**: はい、1つのトークンですべてのプロジェクトにアクセスできます。

### Q4: トークンを忘れた場合はどうすればいいですか？

**A**: GitHubでトークンを再表示することはできません。新しいトークンを生成して再設定してください。

### Q5: トークンが漏洩した場合はどうすればいいですか？

**A**: 直ちに以下の手順を実行してください：
1. GitHubでトークンを削除
2. 新しいトークンを生成
3. 設定ページで新しいトークンを設定

---

## サポート

問題が解決しない場合は、以下を確認してください：

1. ブラウザのコンソール（F12）でエラーメッセージを確認
2. ネットワークタブでAPI呼び出しの状態を確認
3. GitHubのトークン設定ページで権限を確認
4. このガイドのトラブルシューティングセクションを参照

---

**最終更新**: 2024年12月17日  
**バージョン**: 1.0.0
